


#113
#other
select  
	a.spend_date, 
	a.platform,
	isnull(SUM(b.amount),0) total_amount,
	isnull(count(user_id),0) as total_users 
from(
select distinct spend_date, 'mobile' as platform  FROM [113_spending]
union 
select distinct spend_date, 'desktop' as platform FROM [113_spending]
union
select distinct spend_date, 'both' as platform  FROM [113_spending]
)a
left join
(SELECT 
	user_id,
	spend_date, 
	SUM(amount) amount,
	(CASE WHEN COUNT(DISTINCT platform)>1 THEN 'both' ELSE min(platform) END)as platform
FROM [113_spending]
GROUP BY 
	spend_date, 
	user_id)b
on a.spend_date=b.spend_date
and a.platform=b.platform
GROUP BY 
	a.spend_date,
	a.platform
order by 
	a.spend_date,
	a.platform

#113 my1
with a 	as (select *,
					count(platform) over (partition by spend_date,user_id) as nu
			from [113_spending]),
s as (
		select 
			distinct aa.spend_date,
				ss.platform
		from  [113_spending] aa
		cross join (
					select 
						distinct platform 
					from [113_spending]
					union 
					select 'both'
					)ss
	)

select 
	s.spend_date,
	s.platform,
	isnull(b.total_amount,0) as total_amount,
	isnull(b.total_users,0) as total_users
from s
left join(
select 
	a.spend_date,
	'both' as platform ,
	sum(a.amount) as total_amount,
	count(distinct a.user_id) as total_users
from a 
where a.nu=2 
group by a.spend_date
union 
select 
	a.spend_date,
	a.platform ,
	sum(a.amount) as total_amount,
	count(a.user_id) as total_users
from a 
where a.nu=1 
group by a.spend_date,
		 a.platform
		)b
on s.spend_date=b.spend_date 
and s.platform=b.platform
#113 my2
select  s.[spend_date],
		isnull(b.[platform],'both')[platform],
		isnull( b.total_amount,0)total_amount ,
		isnull(b.total_users ,0)total_users
from 
	(SELECT DISTINCT(spend_date), 'desktop' platform FROM [113_spending]
	UNION
	SELECT DISTINCT(spend_date), 'mobile' platform FROM [113_spending]
	UNION
	SELECT DISTINCT(spend_date), 'both' platform FROM [113_spending]
	)s
left join 
	(select [spend_date],
			p [platform],
			case when p='both' then count(distinct user_id) else count( user_id)end total_users ,
			sum([amount])total_amount 
	from(
		SELECT [user_id]
			  ,[spend_date]
			  ,[platform]
			  ,[amount]
			  ,case when count([platform])over(partition by [user_id],[spend_date])>1 then 'both' else [platform] end p
		  FROM [master].[dbo].[113_spending]
		  )a
		  group by [spend_date],
				p
	)b
on s.spend_date=b.spend_date and s.[platform]=b.[platform]

#101 Number of transactions per visit
  with t1 as (
  select c,count(c)visits_count 
  from(
  SELECT e.user_id,visit_date ,sum(case when t.user_id is null then 0 else 1 end) c
  FROM [master].[dbo].[101_visits]e
  left join [master].[dbo].[101_transactions]t
  on e.[user_id]=t.[user_id] and e.[visit_date]=t.[transaction_date]
  group by e.user_id,visit_date
  )a
  group by c
  ),
  t as(
 select max(c) as transactions_count
 from t1
 union all
 select transactions_count -1
 from t
 where transactions_count >0
 )

  select transactions_count ,isnull(visits_count,0)visits_count
  from t
  left join t1
  on t.transactions_count =t1.c
  order by transactions_count 

#98 Trips and Users
select  [request_at]  Day ,
		cast(round(cast(sum(case when [status]!='completed' then 1 else 0 end) as decimal(9,2))/count(*),2)as decimal(9,2))'Cancellation Rate'
from(
 SELECT [client_id]
      ,[driver_id]
      ,[status]
      ,[request_at]
  FROM [master].[dbo].[98_trips] t
  join[98_users]p
  on t.[client_id]=p.users_id
  join[98_users]p1
  on t.[driver_id]=p1.users_id
  where p.banned !='Yes' and p1.banned !='Yes' and[request_at] between '2013-10-01' and '2013-10-03'
)a
group by [request_at]
